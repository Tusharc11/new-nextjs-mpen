# Complete Simplified Deployment Guide - Next.js to EC2

Let me simplify everything and explain **WHY** we use each tool, **WHERE** to add scripts, and **HOW** to set up everything including your domain.

---

## ðŸ¤” WHY PM2 and Nginx? (Simple Explanation)

### Why PM2?
Think of PM2 as a **"babysitter" for your Node.js app**:
- âœ… **Keeps app running 24/7** - If it crashes, PM2 restarts it automatically
- âœ… **Starts on server reboot** - EC2 restarts? App starts automatically
- âœ… **Zero downtime updates** - Updates app without stopping it
- âœ… **Easy logs** - See what's happening with one command
- âœ… **Memory management** - Restarts if app uses too much RAM

**Without PM2:** You'd need to manually restart your app every time it crashes or server restarts.

### Why Nginx?
Think of Nginx as a **"receptionist" at a hotel**:
- âœ… **Handles HTTPS/SSL** - Makes your site secure (https://)
- âœ… **Domain mapping** - Connects `testapp.mpencil.in` to your app
- âœ… **Better performance** - Serves static files faster
- âœ… **Load balancing** - Can handle multiple servers if you scale
- âœ… **Security** - Protects your app from direct internet attacks

**Without Nginx:** You can't easily use your domain or HTTPS. Users would have to access `http://IP:3000` (unprofessional).

### Is This the Best Approach?
**YES** for EC2. This is the industry standard for deploying Node.js apps on EC2:
- Used by companies like Netflix, LinkedIn, PayPal
- Battle-tested for production
- Free and open-source
- Well-documented

**Alternative:** Use Vercel/Netlify (easier but costs more for scaling, less control)

---

## ðŸ“‹ COMPLETE STEP-BY-STEP GUIDE

I'll break this into **5 simple phases** with exact steps.

---

## PHASE 1: AWS SSM Setup (For Secure Environment Variables)

### What is AWS SSM Parameter Store?
It's a **secure vault** for storing secrets (like database passwords) in AWS. Better than hardcoding secrets.

### Step 1: Create SSM Parameters

1. **Go to AWS Console** â†’ Search for **"Systems Manager"**
2. Click **"Parameter Store"** (left sidebar)
3. Click **"Create parameter"**

**Create these parameters ONE BY ONE:**

| Parameter Name | Type | Value (Example) |
|----------------|------|-----------------|
| `/nextjs-app/mongodb-uri` | SecureString | `mongodb+srv://user:pass@cluster.net/erp` |
| `/nextjs-app/nextauth-url` | String | `https://testapp.mpencil.in` |
| `/nextjs-app/nextauth-secret` | SecureString | `[Run: openssl rand -base64 32]` |
| `/nextjs-app/jwt-secret` | SecureString | `[Run: openssl rand -base64 32]` |
| `/nextjs-app/api-secret` | SecureString | `[Run: openssl rand -hex 32]` |
| `/nextjs-app/public-api-url` | String | `https://testapp.mpencil.in` |

**For each parameter:**
- Click "Create parameter"
- Name: (from table above)
- Type: (from table above)
- Value: (your actual value)
- Click "Create parameter"

### Step 2: Create IAM Role for EC2

1. Go to **IAM** â†’ **Roles** â†’ **"Create role"**
2. Select **"AWS service"** â†’ **"EC2"** â†’ Click "Next"
3. Search and add these policies:
   - `AmazonSSMManagedInstanceCore`
   - `CloudWatchAgentServerPolicy`
4. Click "Next"
5. Role name: `EC2-NextJS-Role`
6. Click "Create role"

---

## PHASE 2: EC2 Instance Setup### Step-by-Step: Create EC2 Instance

1. **AWS Console** â†’ **EC2** â†’ **Launch Instance**

2. **Configuration:**
   ```
   Name: nextjs-erp-production
   AMI: Ubuntu Server 22.04 LTS
   Instance Type: t2.small (or t2.medium for better performance)
   ```

3. **Key Pair:**
   - Create new: `nextjs-erp-key`
   - Type: RSA, Format: .pem
   - **SAVE FILE SECURELY**

4. **Network Settings:**
   - Allow HTTP (80) from 0.0.0.0/0
   - Allow HTTPS (443) from 0.0.0.0/0
   - Allow SSH (22) from My IP

5. **Storage:** 20 GB (minimum)

6. **Advanced Details:**
   - **IAM instance profile:** Select `EC2-NextJS-Role` (created in Phase 1)
   - **User data:** Copy and paste **Artifact #1** (the bootstrap script above)

7. **Launch Instance**

8. **Get Public IP:** 
   - Wait for "Running" status
   - Copy **Public IPv4 address**

---

## PHASE 3: Domain Setup (Hostinger)

### Step 1: Add DNS Record in Hostinger

1. Login to **Hostinger** â†’ **Domains** â†’ **mpencil.in**
2. Go to **DNS / Nameservers** â†’ **DNS Records**
3. **Add New Record:**

```
Type: A
Name: testapp
Points to: YOUR_EC2_PUBLIC_IP
TTL: 14400 (or default)
```

4. Click **Add Record**
5. Wait **5-30 minutes** for DNS propagation

### Step 2: Verify DNS

```bash
# On your local machine, test if DNS is working:
nslookup testapp.mpencil.in

# Should show your EC2 IP
```

---

## PHASE 4: SSL Certificate (Let's Encrypt)

### SSH into EC2 and Install SSL

```bash
# SSH into EC2
ssh -i nextjs-erp-key.pem ubuntu@YOUR_EC2_IP

# Install Certbot
sudo apt install -y certbot python3-certbot-nginx

# Get SSL certificate
sudo certbot --nginx -d testapp.mpencil.in

# Follow prompts:
# - Enter email: your@email.com
# - Agree to terms: Y
# - Share email: N (optional)
# - Redirect HTTP to HTTPS: 2 (Yes)

# Certbot automatically updates Nginx config!
```

**Done!** Your site is now accessible at: `https://testapp.mpencil.in`

---

## PHASE 5: GitHub Setup

### Step 1: Add Files to Your Repository

I'll show you **EXACTLY WHERE** to add each file:### Step 2: GitHub Actions Workflow File### Step 3: PM2 Ecosystem Config### Step 4: Health Check API (App Router)### Step 5: Health Check API (Pages Router)### Step 6: Configure GitHub Secrets

1. Go to: `https://github.com/Tusharc11/new-nextjs-mpen/settings/secrets/actions`

2. Click **"New repository secret"** for each:

| Secret Name | Value |
|-------------|-------|
| `EC2_HOST` | `testapp.mpencil.in` (or your EC2 IP) |
| `EC2_SSH_KEY` | Entire content of `nextjs-erp-key.pem` file |
| `NEXT_PUBLIC_API_URL` | `https://testapp.mpencil.in` |
| `NEXT_PUBLIC_APP_NAME` | `ERP Application` |

**How to get SSH key:**
```bash
# On your local machine
cat nextjs-erp-key.pem

# Copy EVERYTHING including:
# -----BEGIN RSA PRIVATE KEY-----
# ... all lines ...
# -----END RSA PRIVATE KEY-----
```

---

## PHASE 6: Deploy Your Application

### Step 1: Commit All New Files

```bash
# In your repository
cd new-nextjs-mpen

# Add all new files
git add .github/workflows/deploy.yml
git add ecosystem.config.js
git add app/api/health/route.js  # or pages/api/health.js

# Commit
git commit -m "Add deployment configuration"

# Push to trigger deployment
git push origin main
```

### Step 2: Watch Deployment

1. Go to: `https://github.com/Tusharc11/new-nextjs-mpen/actions`
2. Click on the running workflow
3. Watch steps complete (3-5 minutes)

### Step 3: Access Your App

Open browser: `https://testapp.mpencil.in`

**Done! ðŸŽ‰**

---

## ðŸ“‹ Complete Checklist## ðŸŽ¯ Quick Reference Summary

### What Each Tool Does (Simple):

| Tool | What It Does | Why We Need It |
|------|-------------|----------------|
| **PM2** | Keeps your app running 24/7 | Auto-restarts if crashes, starts on reboot, zero-downtime updates |
| **Nginx** | Handles web traffic | Enables HTTPS, connects domain to app, better performance |
| **SSM** | Stores secrets securely | Better than hardcoding passwords, managed by AWS |

### Files You Need to Add:

| File | Location | Content From |
|------|----------|--------------|
| GitHub Actions | `.github/workflows/deploy.yml` | Artifact #2 |
| PM2 Config | `ecosystem.config.js` (root) | Artifact #3 |
| Health Check | `app/api/health/route.js` | Artifact #4 (App Router) |
| Health Check | `pages/api/health.js` | Artifact #5 (Pages Router) |

### Order of Operations:

```
1. Create SSM parameters (AWS Console)
2. Create IAM role (AWS Console)
3. Create EC2 with bootstrap script (AWS Console)
4. Add DNS record (Hostinger)
5. Install SSL certificate (SSH once)
6. Add files to repo (Local)
7. Add GitHub secrets (GitHub)
8. Push code (Triggers deployment)
```

### After Setup:

**To deploy updates:**
```bash
git add .
git commit -m "Your changes"
git push origin main
```

That's it! GitHub Actions does everything automatically.

**No more SSH needed after initial SSL setup!**

---

## Need Help?

**Check logs:**
```bash
# GitHub Actions logs
https://github.com/Tusharc11/new-nextjs-mpen/actions

# Server logs (if needed)
ssh -i nextjs-erp-key.pem ubuntu@testapp.mpencil.in
pm2 logs nextjs-app
```

Follow the **Simple Deployment Checklist** (Artifact #7) step by step. Each checkbox takes 1-5 minutes. Total time: ~45 minutes for complete setup.
