name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  APP_DIR: /var/www/nextjs-app
  SSM_PATH: /mpencil-app/test

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: |
          echo "Installing dependencies..."
          npm ci

      - name: Build Next.js Application
        env:
          NODE_ENV: production
        run: |
          echo "Building Next.js app..."
          npm run build
          echo "Build completed"

      - name: Create Deployment Package
        run: |
          echo "Creating deployment package..."
          
          mkdir -p deploy-package
          
          cp -r .next deploy-package/
          
          [ -d "public" ] && cp -r public deploy-package/ || echo "No public folder"
          
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          cp next.config.* deploy-package/ 2>/dev/null || true
          
          cp fetch-ssm-env.sh deploy-package/
          
          [ -f "ecosystem.config.js" ] && cp ecosystem.config.js deploy-package/ || echo "No ecosystem.config.js"
          
          tar -czf deploy.tar.gz -C deploy-package .
          
          echo "Package created"
          echo "Package size: $(du -h deploy.tar.gz | cut -f1)"
          echo "Contents:"
          tar -tzf deploy.tar.gz | head -20

      - name: Upload Package to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 15m
          script: |
            set -e
            
            echo "=========================================="
            echo "Deploying to EC2 (Amazon Linux 2)"
            echo "=========================================="
            
            echo "Stopping application..."
            pm2 stop nextjs-app 2>/dev/null || echo "App not running"
            
            echo "Creating backup..."
            if [ -d "${{ env.APP_DIR }}/current" ]; then
              sudo mv ${{ env.APP_DIR }}/current ${{ env.APP_DIR }}/backup-$(date +%Y%m%d_%H%M%S)
              cd ${{ env.APP_DIR }}
              sudo ls -dt backup-* 2>/dev/null | tail -n +4 | xargs sudo rm -rf || true
            fi
            
            sudo mkdir -p ${{ env.APP_DIR }}/current
            
            echo "Extracting deployment package..."
            sudo tar -xzf /tmp/deploy.tar.gz -C ${{ env.APP_DIR }}/current
            sudo rm /tmp/deploy.tar.gz
            
            sudo chown -R ec2-user:ec2-user ${{ env.APP_DIR }}/current
            
            cd ${{ env.APP_DIR }}/current
            
            chmod +x fetch-ssm-env.sh
            
            echo "Fetching environment from SSM..."
            SSM_PATH="${{ env.SSM_PATH }}" \
            ENV_FILE="${{ env.APP_DIR }}/current/.env.production" \
            ./fetch-ssm-env.sh
            
            if [ ! -f ".env.production" ]; then
              echo "ERROR: .env.production not created"
              echo "Checking SSM script output..."
              ls -la
              exit 1
            fi
            
            echo "Environment variables loaded"
            
            echo "Installing production dependencies..."
            npm ci --omit=dev --prefer-offline --no-audit
            
            cd ${{ env.APP_DIR }}
            
            if [ ! -f "current/ecosystem.config.js" ]; then
              echo "ecosystem.config.js not found in deployment, using existing one"
              if [ ! -f "ecosystem.config.js" ]; then
                echo "ERROR: No ecosystem.config.js found"
                exit 1
              fi
            else
              cp current/ecosystem.config.js ecosystem.config.js
            fi
            
            echo "Starting application..."
            if pm2 describe nextjs-app > /dev/null 2>&1; then
              pm2 reload ecosystem.config.js --update-env
              echo "App reloaded (zero downtime)"
            else
              pm2 start ecosystem.config.js
              echo "App started"
            fi
            
            pm2 save
            
            echo "Running health check..."
            sleep 5
            
            if pm2 describe nextjs-app | grep -q "online"; then
              echo "=========================================="
              echo "Deployment Successful!"
              echo "=========================================="
              pm2 status
              pm2 info nextjs-app
            else
              echo "=========================================="
              echo "Deployment Failed"
              echo "=========================================="
              pm2 logs nextjs-app --lines 50 --nostream
              exit 1
            fi

      - name: Deployment Summary
        if: success()
        run: |
          echo "=========================================="
          echo "Deployment Completed Successfully!"
          echo "=========================================="
          echo ""
          echo "Application URL: https://testapp.mpencil.in"
          echo "Deployed at: $(date)"
          echo ""
          echo "Next steps:"
          echo "  1. Visit your application URL"
          echo "  2. Check PM2 logs: ssh ec2-user@${{ secrets.EC2_HOST }} 'pm2 logs'"
          echo "  3. Monitor: ssh ec2-user@${{ secrets.EC2_HOST }} 'pm2 monit'"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "Deployment Failed"
          echo "=========================================="
          echo ""
          echo "Troubleshooting steps:"
          echo "  1. Check EC2 logs: ssh ec2-user@${{ secrets.EC2_HOST }} 'pm2 logs'"
          echo "  2. Check SSM parameters: aws ssm get-parameters-by-path --path /mpencil-app/test"
          echo "  3. Verify EC2 IAM role has SSM permissions"
          echo "  4. Check GitHub Actions logs above for details"
