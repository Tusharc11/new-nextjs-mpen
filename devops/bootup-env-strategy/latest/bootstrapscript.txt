#!/bin/bash
# Bootstrap script for Next.js SSR application on Amazon Linux 2023
# Paste this in EC2 User Data section during instance creation

set -e  # Exit if any command fails

# Update system packages
dnf update -y

# Install Node.js 20 (required for Next.js)
curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
dnf install -y nodejs

# Install PM2 (keeps your Next.js app running 24/7)
npm install -g pm2

# Install Nginx (handles domain and HTTPS)
dnf install -y nginx
systemctl enable nginx  # Start on boot
systemctl start nginx

# Create directory for Next.js app
mkdir -p /var/www/nextjs-app/logs
chown -R ec2-user:ec2-user /var/www/nextjs-app

# Configure Nginx to forward traffic to Next.js (port 3000)
cat > /etc/nginx/conf.d/nextjs-app.conf << 'EOF'
server {
    listen 80;
    server_name testapp.mpencil.in;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# Test config and restart Nginx
nginx -t && systemctl restart nginx

# Make PM2 start automatically on server reboot
env PATH=$PATH:/usr/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u ec2-user --hp /home/ec2-user

# Allow Nginx to connect to Node.js (Amazon Linux security)
setsebool -P httpd_can_network_connect 1

echo "âœ… Bootstrap completed! Ready for Next.js SSR deployment."
