# Complete Deployment Guide - With SSM Fetch Script

## Overview

We'll use a **dedicated SSM fetch script** that runs on EC2 during deployment to automatically create the `.env.production` file.

---

## Architecture

```
GitHub Actions (ubuntu-latest - GitHub's server)
    â†“ Builds app
    â†“ Uploads to EC2
    â†“ SSH into EC2
          â†“
EC2 (Amazon Linux 2023 - Your server)
    â†“ Runs SSM fetch script
    â†“ Creates .env.production
    â†“ PM2 starts app
```

**Important:** `runs-on: ubuntu-latest` means GitHub Actions runs on **GitHub's Ubuntu server** (not your EC2). This is free and provided by GitHub. Your EC2 stays Amazon Linux.

---

## Step 1: Add Files to Repository

You have **3 options** to add files. Choose one:

### Option A: Using Git Bash (Windows)

#### Install Git Bash (if not installed)

1. Download: https://git-scm.com/download/win
2. Install with default settings
3. Open **Git Bash** from Start Menu

#### Clone Repository

```bash
# Clone the repository
cd /c/Users/YourName/Documents  # Navigate to your desired folder
git clone https://github.com/Tusharc11/new-nextjs-mpen.git
cd new-nextjs-mpen

# Check current branch
git branch
# Shows: * main (or * master)
```

#### Create Directory Structure

```bash
# Create workflows directory
mkdir -p .github/workflows

# Create health check directory (check your Next.js version first)
# For App Router (Next.js 13+):
mkdir -p app/api/health

# For Pages Router (Next.js 12):
mkdir -p pages/api
```

#### Create Files Using Git Bash

```bash
# Create GitHub Actions workflow
touch .github/workflows/deploy.yml

# Create PM2 config
touch ecosystem.config.js

# Create SSM fetch script
touch fetch-ssm-env.sh

# Create health check (choose one)
touch app/api/health/route.js     # For App Router
# OR
touch pages/api/health.js          # For Pages Router
```

#### Open Files and Paste Content

**Option 1: Use VS Code**
```bash
# Open entire project in VS Code
code .
```

**Option 2: Use Notepad++**
```bash
# Open specific file in Notepad++
notepad++ .github/workflows/deploy.yml
```

**Option 3: Use Windows Notepad**
```bash
# Open with default text editor
notepad .github/workflows/deploy.yml
```

Then paste the content from the artifacts below.

---

### Option B: Using GitHub Web UI (No Git Bash Required)

#### 1. Go to Your Repository
```
https://github.com/Tusharc11/new-nextjs-mpen
```

#### 2. Create Workflow File

1. Click **"Add file"** â†’ **"Create new file"**
2. In filename box, type: `.github/workflows/deploy.yml`
   - GitHub automatically creates folders when you use `/`
3. Paste content from **Artifact #1** below
4. Scroll down, commit message: "Add deployment workflow"
5. Click **"Commit new file"**

#### 3. Create PM2 Config

1. Click **"Add file"** â†’ **"Create new file"**
2. Filename: `ecosystem.config.js`
3. Paste content from **Artifact #2** below
4. Commit: "Add PM2 config"

#### 4. Create SSM Script

1. Click **"Add file"** â†’ **"Create new file"**
2. Filename: `fetch-ssm-env.sh`
3. Paste content from **Artifact #3** below
4. Commit: "Add SSM fetch script"

#### 5. Create Health Check

**For App Router:**
1. Click **"Add file"** â†’ **"Create new file"**
2. Filename: `app/api/health/route.js`
3. Paste content from **Artifact #4** below
4. Commit: "Add health check endpoint"

**For Pages Router:**
1. Filename: `pages/api/health.js`
2. Paste content from **Artifact #5** below

---

### Option C: Using Windows File Explorer + Git Bash Commit

#### 1. Clone Repository

Open **Git Bash**:
```bash
cd /c/Users/YourName/Documents
git clone https://github.com/Tusharc11/new-nextjs-mpen.git
cd new-nextjs-mpen
```

#### 2. Open Folder in Windows Explorer

```bash
# Open current folder in Windows Explorer
explorer .
```

#### 3. Create Folders Using Windows

- Right-click â†’ New â†’ Folder â†’ `.github`
- Inside `.github` â†’ New â†’ Folder â†’ `workflows`
- Create folders: `app\api\health` (if App Router)

#### 4. Create Files Using Notepad

- Right-click in folder â†’ New â†’ Text Document
- Rename to: `deploy.yml` (remove .txt extension)
- Double-click to open
- Paste content from artifacts below
- Save and close

Repeat for all files.

#### 5. Commit Using Git Bash

```bash
# In Git Bash, in repository folder
git add .
git commit -m "Add deployment configuration"
git push origin main
```

---

## Step 2: All Required Files

### Artifact #1: GitHub Actions Workflow

**File:** `.github/workflows/deploy.yml`### Artifact #2: PM2 Config

**File:** `ecosystem.config.js`### Artifact #3: SSM Fetch Script

**File:** `fetch-ssm-env.sh`### Artifact #4: Health Check (App Router)

**File:** `app/api/health/route.js`

```javascript
// app/api/health/route.js
import { NextResponse } from 'next/server';

export async function GET() {
  return NextResponse.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
  });
}
```

### Artifact #5: Health Check (Pages Router)

**File:** `pages/api/health.js`

```javascript
// pages/api/health.js
export default function handler(req, res) {
  res.status(200).json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
  });
}
```

---

## Step 3: Create GitHub Secrets (Windows Steps)

### 3.1: Get Your SSH Key Content

Open **PowerShell** (Windows key + X â†’ PowerShell):

```powershell
# Navigate to where you saved the .pem file
cd C:\Users\YourName\Downloads

# Display the key content
Get-Content nextjs-erp-key.pem -Raw
```

**Or use Notepad:**
1. Right-click `nextjs-erp-key.pem`
2. Open with Notepad
3. Copy **EVERYTHING** (Ctrl+A, Ctrl+C)

The content looks like:
```
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA...
... many lines ...
-----END RSA PRIVATE KEY-----
```

### 3.2: Add Secrets in GitHub

#### Navigate to Secrets Page

**Option 1: Direct URL**
```
https://github.com/Tusharc11/new-nextjs-mpen/settings/secrets/actions
```

**Option 2: Manual**
1. Go to: https://github.com/Tusharc11/new-nextjs-mpen
2. Click **Settings** tab (top menu)
3. Left sidebar: **Secrets and variables** â†’ **Actions**

#### Add Secret #1: EC2_HOST

1. Click **"New repository secret"** (green button)
2. Fill in:
   - **Name:** `EC2_HOST`
   - **Secret:** `testapp.mpencil.in`
3. Click **"Add secret"**

#### Add Secret #2: EC2_SSH_KEY

1. Click **"New repository secret"**
2. Fill in:
   - **Name:** `EC2_SSH_KEY`
   - **Secret:** Paste the **entire .pem file content** from step 3.1
3. **Critical:** Must include BEGIN and END lines
4. Click **"Add secret"**

#### Verify Secrets

You should see:
- âœ… `EC2_HOST`
- âœ… `EC2_SSH_KEY`

---

## Step 4: Commit and Push (Choose Method)

### Method A: Git Bash

```bash
# Check what files you're adding
git status

# Add all files
git add .github/workflows/deploy.yml
git add ecosystem.config.js
git add fetch-ssm-env.sh
git add app/api/health/route.js  # or pages/api/health.js

# Or add everything
git add .

# Commit
git commit -m "Add deployment configuration with SSM script

- GitHub Actions workflow for CI/CD
- PM2 ecosystem config
- SSM parameter fetch script
- Health check endpoint
"

# Push (triggers deployment!)
git push origin main
```

### Method B: GitHub Desktop (Windows GUI)

1. Download: https://desktop.github.com
2. Install and login
3. Add repository: File â†’ Add Local Repository
4. Select your repo folder
5. Check boxes for all files
6. Commit message: "Add deployment configuration"
7. Click **"Commit to main"**
8. Click **"Push origin"** (triggers deployment!)

### Method C: Already Added via Web UI

If you added files via GitHub web interface, they're already committed and pushed. Skip to Step 5.

---

## Step 5: Monitor Deployment

### 5.1: Go to Actions Tab

```
https://github.com/Tusharc11/new-nextjs-mpen/actions
```

### 5.2: Watch Workflow

1. You'll see a new workflow run (appears within seconds)
2. Click on it
3. Click **"deploy"** job
4. Watch steps execute:

```
âœ… Checkout Code             (~5 sec)
âœ… Setup Node.js             (~10 sec)
âœ… Install Dependencies      (~30-60 sec)
âœ… Build Application         (~30-90 sec)
âœ… Create Deployment Package (~10 sec)
âœ… Upload to EC2             (~10-30 sec)
âœ… Deploy Application        (~60-120 sec)
   â”œâ”€ Extract files
   â”œâ”€ Install dependencies
   â”œâ”€ Run SSM fetch script  â† Creates .env.production
   â”œâ”€ PM2 reload
   â””â”€ Verify status
âœ… Deployment Summary        (~5 sec)
```

### 5.3: Check SSM Script Output

In the "Deploy Application" step, you'll see:

```
========================================
SSM Parameter Fetcher
========================================
Configuration:
  SSM Path: /mpencil-app/test
  Target File: /var/www/nextjs-app/.env.production
  Region: us-east-1

Found 6 parameter(s)
Processing parameters...

  âœ“ MONGODB_URI
  âœ“ JWT_SECRET
  âœ“ S3_REGION
  âœ“ S3_ACCESS_KEY_ID
  âœ“ S3_SECRET_ACCESS_KEY
  âœ“ S3_BUCKET_NAME

Environment file created!
```

### 5.4: Success Indicators

All steps show green checkmarks âœ…

Final message:
```
âœ… Deployment completed!
ğŸŒ URL: https://testapp.mpencil.in
```

---

## Step 6: Verify Deployment

### 6.1: Test in Browser

Open: `https://testapp.mpencil.in`

Should see:
- âœ… Green lock (HTTPS)
- âœ… Your Next.js app loads
- âœ… All features work

### 6.2: Test Health Endpoint

Open: `https://testapp.mpencil.in/api/health`

Should return:
```json
{
  "status": "healthy",
  "timestamp": "2024-...",
  "uptime": 123.45
}
```

### 6.3: SSH Check (Optional)

**Using PowerShell on Windows:**

```powershell
# Navigate to key location
cd C:\Users\YourName\Downloads

# SSH into EC2
ssh -i nextjs-erp-key.pem ec2-user@testapp.mpencil.in
```

**Using Git Bash:**

```bash
# SSH into EC2
ssh -i /c/Users/YourName/Downloads/nextjs-erp-key.pem ec2-user@testapp.mpencil.in
```

**Once connected:**

```bash
# Check PM2 status
pm2 status
# Should show: nextjs-app | online

# Check .env file was created
ls -la /var/www/nextjs-app/.env.production

# View .env structure (values hidden)
grep -v '^#' /var/www/nextjs-app/.env.production | grep -v '^$' | sed 's/=.*/=***/'

# View logs
pm2 logs nextjs-app --lines 20

# Exit
exit
```

---

## Understanding: Why `runs-on: ubuntu-latest`?

### Common Confusion

**Question:** "My EC2 is Amazon Linux, why does workflow say `ubuntu-latest`?"

**Answer:** Because they're **different machines**!

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions Server                  â”‚
â”‚  (GitHub's infrastructure - FREE)       â”‚
â”‚                                         â”‚
â”‚  OS: ubuntu-latest                      â”‚
â”‚  Purpose: Build your app                â”‚
â”‚  Location: GitHub's data center         â”‚
â”‚                                         â”‚
â”‚  What it does:                          â”‚
â”‚  1. Checkout code                       â”‚
â”‚  2. Install Node.js                     â”‚
â”‚  3. Run npm ci                          â”‚
â”‚  4. Run npm run build                   â”‚
â”‚  5. Create package                      â”‚
â”‚  6. Upload to YOUR EC2 via SSH          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ SSH connection
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Your EC2 Server                        â”‚
â”‚  (Your AWS account)                     â”‚
â”‚                                         â”‚
â”‚  OS: Amazon Linux 2023                  â”‚
â”‚  Purpose: Run your app                  â”‚
â”‚  Location: AWS data center              â”‚
â”‚                                         â”‚
â”‚  What it does:                          â”‚
â”‚  1. Receive package from GitHub         â”‚
â”‚  2. Extract files                       â”‚
â”‚  3. Run SSM fetch script                â”‚
â”‚  4. Start app with PM2                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**
- âœ… GitHub Actions runs on **GitHub's Ubuntu server** (free)
- âœ… Your app runs on **your Amazon Linux EC2**
- âœ… GitHub builds, your EC2 runs
- âœ… They communicate via SSH

**You don't need to change `runs-on: ubuntu-latest`** - it's correct!

---

## Complete File Checklist

Verify you have these files:

```
new-nextjs-mpen/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ deploy.yml           â† Artifact #1
â”œâ”€â”€ app/api/health/
â”‚   â””â”€â”€ route.js                 â† Artifact #4 (App Router)
OR
â”œâ”€â”€ pages/api/
â”‚   â””â”€â”€ health.js                â† Artifact #5 (Pages Router)
â”œâ”€â”€ ecosystem.config.js          â† Artifact #2
â”œâ”€â”€ fetch-ssm-env.sh             â† Artifact #3
â”œâ”€â”€ package.json
â””â”€â”€ ... (other existing files)
```

---

## Troubleshooting

### Issue: SSM Script Fails

**Error in logs:** `No parameters found at path: /mpencil-app/test`

**Check:**
1. SSM parameters exist in AWS
2. IAM role is attached to EC2
3. Parameter names match exactly

**Solution:**
```bash
# SSH into EC2
ssh -i nextjs-erp-key.pem ec2-user@testapp.mpencil.in

# Test SSM access
aws ssm get-parameters-by-path \
  --path "/mpencil-app/test" \
  --with-decryption

# If error, check IAM role
# EC2 Console â†’ Instance â†’ Actions â†’ Security â†’ Modify IAM role
```

### Issue: jq Not Found

**Error:** `jq: command not found`

**Solution:** Script auto-installs jq. If it fails:

```bash
# SSH into EC2
sudo dnf install -y jq
```

### Issue: Permission Denied on Script

**Error:** `Permission denied: fetch-ssm-env.sh`

**Solution:** Script is made executable in workflow. If manual run:

```bash
chmod +x /var/www/nextjs-app/fetch-ssm-env.sh
```

---

## Summary

âœ… **No GitHub Runner needed** - Uses GitHub's free infrastructure  
âœ… **SSM script runs on EC2** - Automatically creates .env.production  
âœ… **3 ways to add files** - Git Bash, Web UI, or GitHub Desktop  
âœ… **Windows-friendly** - PowerShell and Git Bash instructions  
âœ… **Automatic deployment** - Just push code!  

**Total files to add:** 4 files  
**Total secrets:** 2 secrets  
**Deployment time:** 3-5 minutes  

ğŸš€ **Your app is now ready for automated deployment!**
