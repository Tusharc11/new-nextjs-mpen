#!/bin/bash
# ============================================================================
# EC2 BOOTSTRAP SCRIPT - AMAZON LINUX 2023
# ============================================================================
set -e
exec > >(tee /var/log/user-data.log)
exec 2>&1

echo "ðŸš€ Starting EC2 Bootstrap"

# ----------------------------
# Detect region
# ----------------------------
REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
echo "Region: $REGION"

# ----------------------------
# System update
# ----------------------------
dnf update -y

# ----------------------------
# Install Node.js 20
# ----------------------------
curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
dnf install -y nodejs

# ----------------------------
# Install PM2
# ----------------------------
npm install -g pm2

# ----------------------------
# Install Nginx
# ----------------------------
dnf install -y nginx
systemctl enable nginx
systemctl start nginx

# ----------------------------
# App directories
# ----------------------------
mkdir -p /var/www/nextjs-app/logs
chown -R ec2-user:ec2-user /var/www/nextjs-app

# ----------------------------
# Fetch ENV from SSM
# ----------------------------
echo "Fetching environment variables from SSM"

SSM_BASE="/mpencil-app/test"

get_ssm_param() {
  aws ssm get-parameter \
    --name "$1" \
    --with-decryption \
    --region "$REGION" \
    --query 'Parameter.Value' \
    --output text
}

cat > /var/www/nextjs-app/.env.production << EOF
NODE_ENV=production
PORT=3000

# Database
MONGODB_URI=$(get_ssm_param "$SSM_BASE/MONGODB_URI")

# Auth
JWT_SECRET=$(get_ssm_param "$SSM_BASE/JWT_SECRET")

# S3
S3_REGION=$(get_ssm_param "$SSM_BASE/S3_REGION")
S3_ACCESS_KEY_ID=$(get_ssm_param "$SSM_BASE/S3_ACCESS_KEY_ID")
S3_SECRET_ACCESS_KEY=$(get_ssm_param "$SSM_BASE/S3_SECRET_ACCESS_KEY")
S3_BUCKET_NAME=$(get_ssm_param "$SSM_BASE/S3_BUCKET_NAME")
EOF

chmod 600 /var/www/nextjs-app/.env.production
chown ec2-user:ec2-user /var/www/nextjs-app/.env.production

echo "SSM env vars written to .env.production"

# ----------------------------
# Nginx config
# ----------------------------
cat > /etc/nginx/conf.d/nextjs-app.conf << 'NGINX'
server {
    listen 80;
    server_name testapp.mpencil.in;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
NGINX

nginx -t && systemctl restart nginx

# ----------------------------
# PM2 config
# ----------------------------
cat > /var/www/nextjs-app/ecosystem.config.js << 'PM2'
module.exports = {
  apps: [{
    name: 'nextjs-app',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/nextjs-app',
    env_file: '/var/www/nextjs-app/.env.production',
    autorestart: true,
    watch: false
  }]
}
PM2

chown ec2-user:ec2-user /var/www/nextjs-app/ecosystem.config.js

# Enable PM2 on boot
env PATH=$PATH:/usr/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u ec2-user --hp /home/ec2-user

# Allow Nginx â†’ Node
setsebool -P httpd_can_network_connect 1

echo "âœ… Bootstrap completed"
