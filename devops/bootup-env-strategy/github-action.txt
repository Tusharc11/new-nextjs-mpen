name: Deploy to EC2

# Trigger on push to main branch or manual trigger
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # ========================================================================
      # STEP 1: Checkout Code
      # ========================================================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ========================================================================
      # STEP 2: Setup Node.js
      # ========================================================================
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ========================================================================
      # STEP 3: Install Dependencies
      # ========================================================================
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ========================================================================
      # STEP 4: Build Next.js Application
      # ========================================================================
      - name: ğŸ—ï¸ Build Next.js application
        env:
          # Build-time environment variables (NEXT_PUBLIC_* get embedded in bundle)
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_NAME: ${{ secrets.NEXT_PUBLIC_APP_NAME }}
          NEXT_PUBLIC_STRIPE_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLIC_KEY }}
          # Add any other NEXT_PUBLIC_* variables here
        run: npm run build

      # ========================================================================
      # STEP 5: Create Deployment Package
      # ========================================================================
      - name: ğŸ“¦ Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deploy-package
          
          # Copy built files
          cp -r .next deploy-package/
          cp -r public deploy-package/ 2>/dev/null || :
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          # Copy config files
          cp next.config.js deploy-package/ 2>/dev/null || :
          cp next.config.mjs deploy-package/ 2>/dev/null || :
          
          # Copy ecosystem config for PM2
          cat > deploy-package/ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'nextjs-app',
              script: 'npm',
              args: 'start',
              cwd: '/var/www/nextjs-app',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '1G',
              env_file: '/var/www/nextjs-app/.env.production',
              error_file: '/var/www/nextjs-app/logs/err.log',
              out_file: '/var/www/nextjs-app/logs/out.log',
              log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
              merge_logs: true,
              kill_timeout: 5000,
              listen_timeout: 3000,
            }]
          }
          EOF
          
          # Create compressed archive
          tar -czf deploy.tar.gz -C deploy-package .
          echo "âœ… Deployment package created: $(du -h deploy.tar.gz)"

      # ========================================================================
      # STEP 6: Update Environment Variables on EC2 (Automated)
      # ========================================================================
      - name: ğŸ” Update environment variables on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Create/Update .env.production file with all secrets
            cat > /var/www/nextjs-app/.env.production << 'EOF'
            # Auto-generated by GitHub Actions
            # Last updated: $(date)
            
            NODE_ENV=production
            PORT=3000
            
            # MongoDB Connection
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            
            # NextAuth Configuration
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            
            # API Configuration
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            API_SECRET_KEY=${{ secrets.API_SECRET_KEY }}
            
            # JWT Configuration
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            
            # Email Configuration
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
            
            # AWS Configuration
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            
            # Payment Gateway
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            NEXT_PUBLIC_STRIPE_PUBLIC_KEY=${{ secrets.NEXT_PUBLIC_STRIPE_PUBLIC_KEY }}
            
            # Public Variables
            NEXT_PUBLIC_APP_NAME=${{ secrets.NEXT_PUBLIC_APP_NAME }}
            NEXT_PUBLIC_APP_VERSION=1.0.0
            
            # Add any other environment variables here
            EOF
            
            # Set proper permissions
            chmod 600 /var/www/nextjs-app/.env.production
            echo "âœ… Environment variables updated"

      # ========================================================================
      # STEP 7: Transfer Files to EC2
      # ========================================================================
      - name: ğŸ“¤ Copy files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/home/ubuntu/"

      # ========================================================================
      # STEP 8: Deploy Application (Zero Downtime)
      # ========================================================================
      - name: ğŸš€ Deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            
            APP_DIR="/var/www/nextjs-app"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="/home/ubuntu/backups"
            
            echo "=========================================="
            echo "ğŸš€ Starting Deployment Process"
            echo "=========================================="
            
            # Create backup directory
            mkdir -p $BACKUP_DIR
            
            # Backup current version (if exists)
            if [ -d "$APP_DIR/.next" ]; then
              echo "ğŸ“¦ Creating backup of current version..."
              tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C $APP_DIR . 2>/dev/null || true
              # Keep only last 5 backups
              ls -t $BACKUP_DIR/backup_*.tar.gz | tail -n +6 | xargs -r rm
              echo "âœ… Backup created"
            fi
            
            # Extract new version
            echo "ğŸ“‚ Extracting new version..."
            cd $APP_DIR
            tar -xzf /home/ubuntu/deploy.tar.gz
            rm /home/ubuntu/deploy.tar.gz
            echo "âœ… Files extracted"
            
            # Install production dependencies
            echo "ğŸ“¦ Installing production dependencies..."
            npm ci --omit=dev --prefer-offline --no-audit
            echo "âœ… Dependencies installed"
            
            # Reload application with PM2 (zero downtime)
            echo "ğŸ”„ Reloading application..."
            if pm2 describe nextjs-app > /dev/null 2>&1; then
              # App is running, reload it
              pm2 reload ecosystem.config.js --update-env
              echo "âœ… Application reloaded (zero downtime)"
            else
              # App is not running, start it
              pm2 start ecosystem.config.js
              echo "âœ… Application started"
            fi
            
            # Save PM2 process list
            pm2 save
            
            # Wait for app to be healthy
            echo "â³ Waiting for application to be healthy..."
            sleep 5
            
            # Check if app is running
            if pm2 describe nextjs-app | grep -q "online"; then
              echo "âœ… Application is running"
            else
              echo "âŒ Application failed to start"
              pm2 logs nextjs-app --lines 50
              exit 1
            fi
            
            # Test the application
            echo "ğŸ§ª Testing application..."
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Application is responding"
            else
              echo "âš ï¸  Application is not responding on port 3000"
            fi
            
            echo ""
            echo "=========================================="
            echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "=========================================="
            echo ""
            echo "ğŸ“Š Application Status:"
            pm2 status
            echo ""
            echo "ğŸŒ Access your app at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"
            echo ""
            echo "ğŸ“ View logs with: pm2 logs nextjs-app"
            echo "ğŸ”„ Restart with: pm2 restart nextjs-app"
            echo "â¹ï¸  Stop with: pm2 stop nextjs-app"
            echo ""

      # ========================================================================
      # STEP 9: Deployment Summary
      # ========================================================================
      - name: ğŸ“Š Deployment Summary
        if: success()
        run: |
          echo "::notice::âœ… Deployment completed successfully!"
          echo "::notice::ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
          echo "::notice::ğŸ“¦ Build size: $(du -h deploy.tar.gz | cut -f1)"
          echo "::notice::â±ï¸  Deployment time: $(date)"
